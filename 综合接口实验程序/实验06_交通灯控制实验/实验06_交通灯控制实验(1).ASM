;功能：东西、南北红/绿灯时间停留30s，黄灯闪烁3s，整体伴有数码管倒计时显示。紧急按键函数完成编写但硬件还需调试。
;端口：8255:288H-28BH,数码管位码：PA口，数码管段码：PB口。主核CLK：1MHZ，南北灯：PC7/6/5，东西灯：PC2/1/0。
DATAS SEGMENT
  P8255A EQU 2B8H
  P8255C EQU 2B9H
  P8255B EQU 2BAH
  P8255S EQU 2BBH     
  LAMP_TAB DB 24H                       ;north_south green 
           DB 44H,04H,44H,04H,44H,04H   ;north_south yellow
           DB 81H                       ;west_east green
           DB 82H,80H,82H,80H,82H,80H   ;west_east yellow
           DB 0FFH
 ; SM_TAB1  DB 6FH,7FH,07H,7DH,6DH,66H,4FH,5BH,06H,3FH        ;9,8,7,6,5,4,3,2,1,0
    SM_TAB1  DB 0f6H,0feH,0e0H,0beH,0b6H,66H,0f2H,0daH,60H,0fcH        ;9,8,7,6,5,4,3,2,1,0
  SM_TAB2  DB 5BH,06H,3FH                                    ;2,1,0
  SM_TAB3  DB 5BH,5BH,06H,06H,3FH,3FH,5BH,5BH,06H,06H,3FH,3FH;2,2,1,1,0,0
DATAS ENDS
 
STACKS SEGMENT
  X DB 100 DUP(?)
STACKS ENDS
 
CODES SEGMENT
  ASSUME CS:CODES,DS:DATAS,SS:STACKS
START:
  MOV AX,DATAS
  MOV DS,AX
  MOV DX,P8255S
  MOV AL,80H      
  OUT DX,AL
MAINLP:                          ;主循环信号灯显示
  CALL OPLP
  JMP MAINLP
EXIT:
  MOV AH,4CH
  INT 21H
 
OPLP PROC                 ;信号灯显示+数码管计时
  MOV BX,0
  MOV SI,0
LP1:
  MOV DX,P8255C 
  MOV AL,LAMP_TAB[BX]
  CMP AL,0FFH
  JZ  EX1
  OUT DX,AL
  INC BX
  TEST AL,21H
  JZ S1
  CALL LONG30S            ;绿灯情况下的计时与显示
  JMP LP1
S1:
  CALL SHORT05S   
  JMP LP1
EX1:
  RET
OPLP ENDP 
 
LONG30S PROC    
  PUSH CX
  PUSH BX 
  PUSH AX 
  PUSH DX
  PUSH SI 
  MOV CX,3    
  MOV SI,0 
LP2:
  MOV DI,0
  PUSH CX
LP3:
  MOV CX,50
LP4: 
  CALL BTTEST           ;检测按键子程序
  MOV AL,02H            ;由于存在两位数码管，因此需要在两位数码管之间快速刷新
  MOV DX,P8255A      
  OUT DX,AL
  MOV AL,SM_TAB2[SI] 
  MOV DX,P8255B 
  OUT DX,AL
  CALL DELAY_02S
  
  MOV AL,SM_TAB1[DI] 
  MOV DX,P8255B    
  OUT DX,AL
  MOV AL,01H           
  MOV DX,P8255A        
  OUT DX,AL  
  CALL DELAY_02S
  LOOP LP4        
  INC DI 
  CMP DI,10 
  JNE LP3 
  INC SI
  POP CX 
  LOOP LP2 
  
  POP SI
  POP DX 
  POP AX 
  POP BX 
  POP CX 
  RET 
LONG30S  ENDP
 
 
SHORT05S PROC      ;黄灯闪烁情况下的计时与显示
  PUSH CX
  PUSH BX 
  PUSH AX 
  PUSH DX
  MOV AL,01H           
  MOV DX,P8255A        
  OUT DX,AL           
  MOV AL,SM_TAB3[SI] 
  MOV DX,P8255B    
  OUT DX,AL
  CALL DELAY_05S
  INC SI
  POP DX 
  POP AX 
  POP BX 
  POP CX 
  RET
SHORT05S ENDP
 
BTTEST PROC         ;紧急情况处理
PUSH DX
PUSH AX
PUSH BX
PUSH SI
MOV AH,06H
MOV DL,0FFH
INT 21H
CMP AL,13
JNE RENX
JMP ANS1
RENX:
CMP AL,32
JNE EXT2
JMP ANS2
ANS1:
MOV DX,P8255C
MOV AL,84H
OUT DX,AL
CALL BTSM
DEC BX
MOV AL,LAMP_TAB[BX]
OUT DX,AL
JMP EXT2
ANS2:
DEC BX
CMP BX,0
JE A21
MOV DX,P8255C
MOV AL,24H
OUT DX,AL
CALL BTSM
MOV AL,LAMP_TAB[BX]
OUT DX,AL
JMP EXT2
A21:
MOV DX,P8255C
MOV AL,81H
OUT DX,AL
CALL BTSM
MOV AL,LAMP_TAB[BX]
OUT DX,AL
JMP EXT2
EXT2:
POP SI
POP BX
POP AX
POP DX
RET
BTTEST ENDP
 
BTSM PROC
PUSH DX
PUSH CX
PUSH AX
PUSH DI
MOV DI,0
MOV CX,10
LP5:
MOV AL,01H
MOV DX,P8255A
OUT DX,AL
MOV AL,SM_TAB1[DI]
MOV DX,P8255B
OUT DX,AL
CALL DELAY_1S
INC DI
LOOP LP5
POP DI
POP AX
POP CX
POP DX
RET
BTSM ENDP
 
DELAY_02S PROC    
  PUSH CX 
  PUSH SI 
  MOV CX,60              
DD1: MOV SI,4000
DD2: DEC SI
  JNZ DD2
  LOOP DD1
 
POP SI 
POP CX  
RET
DELAY_02S ENDP
 
DELAY PROC    
  PUSH CX 
  PUSH SI 
  MOV CX,30
DD1: MOV SI,4000
DD2: DEC SI
  JNZ DD2
  LOOP DD1
 
POP SI 
POP CX  
RET
DELAY ENDP
 
 
DELAY_05S PROC    
  PUSH CX 
  PUSH SI 
  MOV CX,3000
D1: MOV SI,4000
D2: DEC SI
  JNZ D2
  LOOP D1
 
POP SI 
POP CX  
RET
DELAY_05S ENDP
 
DELAY_1S PROC     
  PUSH CX 
  MOV CX,2 
D3:
  CALL DELAY_05S   
  LOOP D3 
  POP CX 
  RET 
DELAY_1S ENDP
CODES ENDS
  END START